<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta name="generator" content="GNU make coupled with GNU awk to parse templates. Markdown to parse contents." />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="author" content="Clément David" />
  <meta name="keywords" content="davidcl, clement, david, c.david86" />
  <meta name="description" content="Clément David's CV, articles and all official stuff." />
  <meta name="robots" content="all" />

  <title>WesnothSaveParser: save.awk</title>
  <meta name="keywords" content="awk, wesnoth, save, parser, editor" />
  <link rel="stylesheet" type="text/css" href="/davidcl/styles/light.css" media="all" />
  <link rel="stylesheet" type="text/css" href="/davidcl/styles/print.css" media="print" />
  <link rel="stylesheet" type="text/css" href="/davidcl/styles/default.css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/davidcl/styles/highlight.css" />
  
  
  <link rel="Shortcut Icon" type="image/x-icon" href="/davidcl/img/favicon.ico" />
</head>

<body>
  <div id="nonFooter">
    <div id="header"> <div id="banner"></div> <p><a href="/davidcl/index.xhtml">davidcl</a> > <a href="/davidcl/articles/index.xhtml">articles</a> > <a href="/davidcl/articles/WesnothSaveParser/index.xhtml">WesnothSaveParser</a> > save.awk</p> </div>
    <div id="toc"></div>
    <div id="contents"> <pre class="hl"><span class="hl slc">#</span>
<span class="hl slc"># Launch with :  zcat Modif-old.gz | gawk -f save.awk | gzip &gt; Modif.gz</span>
<span class="hl slc">#</span>

<span class="hl kwa">BEGIN</span> <span class="hl sym">{</span>
	side_found <span class="hl sym">=</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">;</span>
	on_unit <span class="hl sym">=</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">;</span>
	dont_print <span class="hl sym">=</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">;</span>

	entete <span class="hl sym">=</span> <span class="hl str">&quot;## Modified values&quot;</span><span class="hl sym">;</span>
	tab_indent <span class="hl sym">=</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">;</span>
	max_exp_value <span class="hl sym">=</span> <span class="hl str">&quot;1&quot;</span><span class="hl sym">;</span>
	exp_value <span class="hl sym">=</span> <span class="hl str">&quot;0&quot;</span><span class="hl sym">;</span>
	max_hitpoints_value <span class="hl sym">=</span> <span class="hl str">&quot;9999&quot;</span><span class="hl sym">;</span>
	other_players_hitpoints <span class="hl sym">=</span> <span class="hl str">&quot;1&quot;</span><span class="hl sym">;</span>

	<span class="hl slc"># CONFIG</span>
	config_sides <span class="hl sym">=</span> <span class="hl str">&quot;1&quot;</span><span class="hl sym">;</span>

	<span class="hl slc"># DEBUG</span>
	DEBUG <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>

	num_side_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	num_max_exp_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	num_exp_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	num_unit_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	not_accessable_unit <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	num_max_hit_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
	num_hit_found <span class="hl sym">=</span> <span class="hl num">0</span><span class="hl sym">;</span>
<span class="hl sym">}</span>

<span class="hl slc"># For all brackets</span>
<span class="hl sym">/</span>\<span class="hl sym">[(</span>\<span class="hl sym">/)</span>?<span class="hl sym">[[:</span>alnum<span class="hl sym">:]]+</span>\<span class="hl sym">]/ {</span>
	on_unit <span class="hl sym">=</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">;</span>
	side_found <span class="hl sym">=</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">;</span>
	not_accessable_unit<span class="hl sym">++;</span>
<span class="hl sym">}</span>

<span class="hl slc"># For `[unit]` expression</span>
<span class="hl sym">/</span>\<span class="hl sym">[</span>unit\<span class="hl sym">]/ {</span>
	on_unit <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
	num_unit_found<span class="hl sym">++;</span>
<span class="hl sym">}</span>

<span class="hl slc"># For this script `##` previous comments</span>
<span class="hl sym">/</span>\<span class="hl slc">#\#/ {</span>
	dont_print <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
<span class="hl sym">}</span>

<span class="hl sym">{</span>
	<span class="hl kwa">if</span> <span class="hl sym">(</span>on_unit <span class="hl sym">==</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">) {</span>

		<span class="hl kwa">split</span> <span class="hl sym">(</span>$<span class="hl num">1</span><span class="hl sym">,</span> result<span class="hl sym">,</span> <span class="hl str">&quot;=&quot;</span><span class="hl sym">);</span>
		<span class="hl kwa">gsub</span> <span class="hl sym">(/</span>\&quot;<span class="hl sym">/,</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">,</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">]);</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;side&quot;</span> <span class="hl sym">) {</span>
			side_found <span class="hl sym">=</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">;</span>
			<span class="hl kwa">split</span> <span class="hl sym">(</span>config_sides<span class="hl sym">,</span> conf_sides<span class="hl sym">,</span> <span class="hl str">&quot; &quot;</span><span class="hl sym">);</span>
			<span class="hl kwa">for</span> <span class="hl sym">(</span>side in conf_sides<span class="hl sym">) {</span>
				<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">] ==</span> conf_sides<span class="hl sym">[</span>side<span class="hl sym">]) {</span>
					num_side_found<span class="hl sym">++;</span>
					side_found <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
				<span class="hl sym">}</span>
			<span class="hl sym">}</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;max_experience&quot;</span><span class="hl sym">) {</span>
			num_max_exp_found<span class="hl sym">++;</span>
			max_exp <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>

			<span class="hl slc"># special case where hand-written max_exp</span>
			<span class="hl kwa">if</span> <span class="hl sym">(</span>max_exp <span class="hl sym">&lt;</span> <span class="hl num">20</span><span class="hl sym">) {</span>
				max_exp <span class="hl sym">=</span> <span class="hl num">20</span><span class="hl sym">;</span>
				reset_max_exp<span class="hl sym">=</span><span class="hl num">1</span><span class="hl sym">;</span>
				dont_print<span class="hl sym">=</span><span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
			<span class="hl sym">}</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;experience&quot;</span><span class="hl sym">) {</span>
			num_exp_found<span class="hl sym">++;</span>
			experience <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
			dont_print <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;max_hitpoints&quot;</span><span class="hl sym">) {</span>
			num_max_hit_found<span class="hl sym">++;</span>
			max_hitpoints <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;hitpoints&quot;</span><span class="hl sym">) {</span>
			num_hit_found<span class="hl sym">++;</span>
			hitpoints <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
			dont_print <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;max_moves&quot;</span><span class="hl sym">) {</span>
			max_moves <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;movement&quot;</span><span class="hl sym">) {</span>
			movement <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
			dont_print <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>result<span class="hl sym">[</span><span class="hl num">1</span><span class="hl sym">] ==</span> <span class="hl str">&quot;moves&quot;</span><span class="hl sym">) {</span>
			moves <span class="hl sym">=</span> result<span class="hl sym">[</span><span class="hl num">2</span><span class="hl sym">];</span>
			dont_print <span class="hl sym">=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>side_found <span class="hl sym">==</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">) {</span>
			<span class="hl kwa">print</span> tab_indent entete<span class="hl sym">;</span>

			<span class="hl slc">#level up next time</span>
			<span class="hl slc"># experience = max_exp-1;</span>

			<span class="hl slc"># as seen in wesnoth/src/unit.cpp:1533,</span>
			<span class="hl slc"># if &quot;hitpoints&quot; is not set then it is set to the max</span>
			hitpoints <span class="hl sym">=</span> max_hitpoints_value<span class="hl sym">;</span>

			<span class="hl slc"># Set moves to max</span>
			movement <span class="hl sym">=</span> max_moves<span class="hl sym">;</span>
			moves <span class="hl sym">=</span> max_moves<span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>side_found <span class="hl sym">==</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">) {</span>
			<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;## Not modified&quot;</span><span class="hl sym">;</span>
			hitpoints <span class="hl sym">=</span> other_players_hitpoints<span class="hl sym">;</span>
		<span class="hl sym">}</span>

		<span class="hl kwa">if</span> <span class="hl sym">(</span>side_found <span class="hl sym">!=</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">) {</span>
			<span class="hl kwa">if</span> <span class="hl sym">(</span>reset_max_exp<span class="hl sym">)</span>
				<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;max_experience=</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span> max_exp <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span><span class="hl sym">;</span>
			<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;experience=</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span> experience <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span><span class="hl sym">;</span>
			<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;hitpoints=</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span> hitpoints <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span><span class="hl sym">;</span>
			<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;movement=</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span> movement <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span><span class="hl sym">;</span>
			<span class="hl kwa">print</span> tab_indent <span class="hl str">&quot;moves=</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span> moves <span class="hl str">&quot;</span><span class="hl esc">\&quot;</span><span class="hl str">&quot;</span><span class="hl sym">;</span>
			side_found <span class="hl sym">=</span> <span class="hl str">&quot;&quot;</span><span class="hl sym">;</span>
		<span class="hl sym">}</span>
	<span class="hl sym">}</span>

	<span class="hl kwa">if</span> <span class="hl sym">(</span>dont_print <span class="hl sym">!=</span> <span class="hl str">&quot;true&quot;</span><span class="hl sym">)</span>
		<span class="hl kwa">print</span> $<span class="hl num">0</span><span class="hl sym">;</span>

	dont_print <span class="hl sym">=</span> <span class="hl str">&quot;false&quot;</span><span class="hl sym">;</span>
<span class="hl sym">}</span>

<span class="hl kwa">END</span> <span class="hl sym">{</span>
	<span class="hl kwa">if</span> <span class="hl sym">(</span>DEBUG<span class="hl sym">) {</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num side found = &quot;</span> num_side_found<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num max exp found = &quot;</span> num_max_exp_found<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num exp found = &quot;</span> num_exp_found<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num unit found = &quot;</span> num_unit_found<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num not accessable unit found = &quot;</span> not_accessable_unit<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num_max_hit_found = &quot;</span> num_max_hit_found<span class="hl sym">;</span>
		<span class="hl kwa">print</span> <span class="hl str">&quot;num_hit_found = &quot;</span> num_hit_found<span class="hl sym">;</span>
	<span class="hl sym">}</span>
<span class="hl sym">}</span>

</pre>
<!--HTML generated by highlight 2.10, http://www.andre-simon.de/-->
 </div>
  </div>

  <div id="footer">
    <p>© 2009+ Clément David - All texts and images can be used
    with respect to the <a href=
    "http://www.opensource.org/licenses/artistic-license-2.0.php">Artistic
    license 2.0</a>.<br /> Generated on 2010-01-10T22:46:08+01:00. 
    <a href="http://validator.w3.org/check/referer" title="Check the validity of this site&#8217;s XHTML">xhtml</a>
    <a href="http://jigsaw.w3.org/css-validator/check/referer" title="Check the validity of this site&#8217;s CSS">css</a>
    <a href="/davidcl/sitemap.xhtml" title="Sitemap of this site">sitemap</a> &nbsp;</p>
  </div>
</body>
</html>

